---
title: "New Constrution Permits"
author: "Asha Bazil"
date: "11/19/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(sf)
library(RSocrata)
library(viridis)
library(spatstat)
library(raster)
library(spdep)
library(FNN)
library(grid)
library(gridExtra)
library(knitr)
library(kableExtra)
library(tidycensus)
library(mapview)
library(RColorBrewer)
library(remotes)
install_github("yonghah/esri2sf")
library(esri2sf)
```


```{r Themes, message=FALSE, warning=FALSE}

mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 13,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2)
  )
}

plotTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle = element_text(face="italic"),
    plot.caption = element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.background = element_rect(fill = "lightskyblue1", color = "white"),
    strip.text = element_text(size=12),
    axis.title = element_text(size=12),
    axis.text = element_text(size=10),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"),
    strip.text.x = element_text(size = 14)
  )
}

palette5 <- c("#25CB10", "#5AB60C", "#8FA108",   "#C48C04", "#FA7800")
```
## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r read in data}
#permits <- 
  #st_read("https://phl.carto.com/api/v2/sql?q=SELECT+*+FROM+permits&filename=permits&format=geojson&skipfields=cartodb_id")


#permits <- 
#st_read("https://phl.carto.com/api/v2/sql?q=SELECT+*+FROM+permits+WHERE+permitissuedate+>=+'2010-01-01'+AND+permitissuedate+<+'2020-02-01'AND+typeofwork+=+'NEW+CONSTRUCTION'&filename=permits&format=geojson&skipfields=cartodb_id")

permits <- 
st_read("https://phl.carto.com/api/v2/sql?q=SELECT+*+FROM+permits+WHERE+permitissuedate+>=+'2010-01-01'+AND+permitissuedate+<+'2020-02-01'AND+permitdescription+=+'RESIDENTIAL+BUILDING+PERMIT'&filename=permits&format=geojson&skipfields=cartodb_id")%>%
  st_transform('ESRI:102729')

mapview(permits)

```

```{r}
#Philadelphia Boundary

boundary<-st_read("http://data.phl.opendata.arcgis.com/datasets/405ec3da942d4e20869d4e1449a2be48_0.geojson")%>%
  st_transform('ESRI:102729')

mapview(boundary)
```

```{r}
#Fishnet code
fishnet <- 
  st_make_grid(boundary,
               cellsize = 50, 
               square = TRUE) %>%
  .[boundary] %>%
  st_sf() %>%
  mutate(uniqueID = rownames(.))

mapview(fishnet)

permit_net <- 
  dplyr::select(permits) %>% #an SF point object
  mutate(countpermits = 1) %>% #giving value of one to each point
  aggregate(., fishnet, sum) %>% #aggregate points. period represents burglaries. sum number of "1" points that fall within each grid cell. aggregate is a type of spatial join. normally would do a join and them summarize, but this does both in one step. 
  mutate(counpermit = replace_na(countpermits, 0), #where there weren't any crimes
         uniqueID = rownames(.),#make into a column
         cvID = sample(round(nrow(fishnet) / 24), 
                       size=nrow(fishnet), replace = TRUE)) #adding a random number to each grid cell for cross validation later

ggplot() +
  geom_sf(data = permit_net, aes(fill = countpermits), color = NA) +
  scale_fill_viridis() +
  labs(title = "Count of Permits for the fishnet") +
  mapTheme()

```




Hannah's Data Wrangling Updates:
## Other Data
Eviction dataset? - biased (Foreclosure; 311?)
Supermarkets built in the last xyz time period
Sanitation reports
Community partner data set
Census data: 
  - Income
  - Race
  - Age of housing units
  - Education level - change in education level
  - Household size
  - Household type (non family increase)

### Grocery Stores
Grocery Stores (for 2018 only, data do not seem to be available on date that grocery stores were built): from Philadelphia Neighborhood Food Retail Website (https://www.opendataphilly.org/dataset/neighborhood-food-retail)
Provides availability of high-produce supply stores vs. low-produce supply stores.
metadata: https://metadata.phila.gov/#home/datasetdetails/568d4b3c13d1bebc0c2a2b0f/representationdetails/5d4c6e160f63a20011c21727/

No Access areas have 0 high-produce supply stores within walking distance (half mile). Low Access areas have either 1 big box store, 1 produce store, or up to 4 limited-access high-produce supply stores. Moderate or High Access and have either 1 or more supermarkets or several high-produce supply stores nearby.
```{r}
food_retail<- st_read("http://data-phl.opendata.arcgis.com/datasets/53b8a1c653a74c92b2de23a5d7bf04a0_0.geojson")
food_retail$HPSS_ACCESS <- factor(food_retail$HPSS_ACCESS, levels = c("Moderate or High Access", "Low Access", "No Access", "NA"))
ggplot()+
  geom_sf(data=food_retail, aes(fill=HPSS_ACCESS))+
  scale_fill_brewer(palette = 'YlOrRd')+
  labs(fill="Level of Access",
        title="Access to High Produce Supply Stores, 2018",
        caption="Census Block Groups categorized by Moderate or High Access, 
       \nLow Access, and No Access to High Produce Supply Stores") +
  mapTheme()
```


### 311 requests 
https://www.opendataphilly.org/dataset/311-service-and-information-requests

Complaints: I figured we could select a subset of the 2014-2020 data (maybe some of the complaint fields?) to use, though it might be tricky if we don't have data before 2014. Let's discuss!
```{r}
service<-st_read("https://phl.carto.com/api/v2/sql?q=SELECT+*+FROM+public_cases_fc+WHERE+service_name+=+'Dangerous+Building+Complaint'&filename=service&format=geojson&skipfields=cartodb_id")
```

Sanitation Data
```{r}
sanitation<-st_read("https://phl.carto.com/api/v2/sql?q=SELECT+*+FROM+public_cases_fc+WHERE+service_name+=+'Sanitation+/+Dumpster+Violation'OR+service_name+=+'Illegal+Dumping'&filename=sanitation&format=geojson&skipfields=cartodb_id")
```

### Neighborhoods (use this for our grouping level?)
```{r}
nhoods_url <- "https://services3.arcgis.com/9nfxWATFamVUTTGb/ArcGIS/rest/services/PhillyNeighborhoodsOct2_WFL1/FeatureServer/0"
nhoods <- esri2sf(nhoods_url, geomType = "esriGeometryPolygon", crs=4326)

ggplot()+
  geom_sf(data=nhoods)+
  mapTheme()
```

### Census Data
Census data: 
  - Income
  - Race
  - Age of housing units
  - Education level - change in education level
  - Household size
  - Household type (non family increase)
```{r}
census_api_key("337be6633f769979b1dfc56e5071279d780c2090", overwrite = TRUE)
variables=c(Median_HHInc="B19013_001",
            Med_Rent="B25064_001",
            Lack_plumb="B25048_003",
            Lack_kitc="B25052_003",
            Med_month_housecost="B25105_001",
            Month_housecost="B25104_001",
            population_own="B25026_002",
            population_rent="B25026_009",
            units_own="B25013_002",
            units_rent="B25013_007",
            total_pop="B01003_001",
            total_white="B02001_002",
            total_black="B02001_003",
            total_latino="B03002_012",
            MeanHouseSize="B25010_001",
            MedAge="B01002_001",
            MedAge_Male="B01002_002",
            MedAge_Female="B01002_003",
            Total_household="B11001_001",
            Family_household="B11001_002",
            Married_household="B11001_003",
            Otherfam_household="B11001_004",
            Non_fam_household="B11001_007",
            Household_under18="B11005_002",
            Household_over65="B11007_002",
            tot_occ_units="B25002_002",
            total_strt_2005later="B25034_002",
            total_poverty="B06012_002E",
            female_bach="B15001_050E",
            male_bach="B15001_009E")

#Need to decide what years and call the census data

Phila_18 <- get_acs(geography = "tract",
                          state = 42,
                          county= 101,
                          variables = variables,
                          year = 2018,
                          survey = "acs5",
                          geometry=T)
```