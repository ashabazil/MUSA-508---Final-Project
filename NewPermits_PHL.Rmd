---
title: "New Constrution Permits"
author: "Asha Bazil"
date: "11/19/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(sf)
library(RSocrata)
library(viridis)
library(spatstat)
library(raster)
library(spdep)
library(FNN)
library(grid)
library(gridExtra)
library(knitr)
library(kableExtra)
library(tidycensus)
library(mapview)
library(RColorBrewer)
library(remotes)
#install_github("yonghah/esri2sf")
#library(esri2sf)

root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")
```


```{r Themes, message=FALSE, warning=FALSE}

mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 13,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2)
  )
}

plotTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle = element_text(face="italic"),
    plot.caption = element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.background = element_rect(fill = "lightskyblue1", color = "white"),
    strip.text = element_text(size=12),
    axis.title = element_text(size=12),
    axis.text = element_text(size=10),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"),
    strip.text.x = element_text(size = 14)
  )
}

palette5 <- c("#25CB10", "#5AB60C", "#8FA108",   "#C48C04", "#FA7800")
```
## Data Wrangling

Here we gather Philadelphia residential building permit data from 2010 through 2019. 

```{r read in data}
#residential building permit

permits <- 
  st_read("https://phl.carto.com/api/v2/sql?q=SELECT+*+FROM+permits+WHERE+permitissuedate+>=+'2010-01-01'+AND+permitissuedate+<+'2020-02-01'AND+permitdescription+=+'RESIDENTIAL+BUILDING+PERMIT'OR+permitdescription+=+'COMMERCIAL+BUILDING+PERMIT'&filename=permits&format=geojson&skipfields=cartodb_id") %>% 
    st_transform('ESRI:102729') 

ggplot() + 
  geom_sf(data = permits)

#mapview(permits)

```

```{r}
#Philadelphia Boundary

boundary<-
st_read("http://data.phl.opendata.arcgis.com/datasets/405ec3da942d4e20869d4e1449a2be48_0.geojson") %>%
st_transform('ESRI:102729') %>%
st_union() 

st_bbox(boundary)

#create a random raster. You would use the dem data.
r <- raster()
#set the extent to the st_bbox() of phil boundary
bb <- extent(2660574.4,2750112.2,204816.8, 304945.4)
#set the values of the raster to the index value basically. Just to create some dummy values that we will later take the mean of.
r <- setValues(r, 1:ncell(r))
#set the extent so the two layers overlay. 
extent(r) <- bb


ggplot() + 
  geom_sf(data = boundary)

#mapview(boundary)
```

```{r}

# uses grid.arrange to organize independent plots
grid.arrange(ncol=2,
ggplot() + 
  geom_sf(data = boundary) +
  geom_sf(data = permits, colour="red", size=0.1, show.legend = "point") +
  labs(title= "Permits, Phil - 2010-2020"),
ggplot() + 
  geom_sf(data = boundary, fill = "grey40") +
  stat_density2d(data = data.frame(st_coordinates(permits)), 
                 aes(X, Y, fill = ..level.., alpha = ..level..),
                 size = 0.01, bins = 40, geom = 'polygon') +
  scale_fill_viridis() +
  scale_alpha(range = c(0.00, 0.35), guide = FALSE) +
  labs(title = "Density of Permits") +
  theme(legend.position = "none"))

#Fishnet code
fishnet <- 
  st_make_grid(boundary,
               cellsize = 500, 
               square = TRUE) %>%
  .[boundary] %>%
  st_sf() %>%
  mutate(uniqueID = rownames(.))

permit_net <- 
  dplyr::select(permits) %>% #an SF point object
  mutate(countpermits = 1) %>% #giving value of one to each point
  aggregate(., fishnet, sum) %>% #aggregate points. period represents burglaries. sum number of "1" points that fall within each grid cell. aggregate is a type of spatial join. normally would do a join and them summarize, but this does both in one step. 
  mutate(counpermit = replace_na(countpermits, 0), #where there weren't any crimes
         uniqueID = rownames(.),#make into a column
         cvID = sample(round(nrow(fishnet) / 24), 
                       size=nrow(fishnet), replace = TRUE)) #adding a random number to each grid cell for cross validation later

ggplot() +
  geom_sf(data = permit_net, aes(fill = countpermits), color = NA) +
  scale_fill_viridis() +
  labs(title = "Count of Permits for the fishnet") +
  mapTheme()

```

### Neighborhoods (use this for our grouping level?)
```{r}
nhoods_url <- "https://services3.arcgis.com/9nfxWATFamVUTTGb/ArcGIS/rest/services/PhillyNeighborhoodsOct2_WFL1/FeatureServer/0"
nhoods <- esri2sf(nhoods_url, geomType = "esriGeometryPolygon", crs=4326)

nhood <- st_read("/Users/ashabazil/Documents/GitHub/geo-data/Neighborhoods_Philadelphia/Neighborhoods_Philadelphia.geojson") %>%
st_transform(st_crs(fishnet)) 

ggplot()+
  geom_sf(data=nhood)+
  mapTheme()
```


## Other Data
Eviction dataset? - biased (Foreclosure; 311?)
Supermarkets built in the last xyz time period
Sanitation reports
Community partner data set
Census data: 
  - Income
  - Race
  - Age of housing units
  - Education level - change in education level
  - Household size
  - Household type (non family increase)

### 311 requests 
https://www.opendataphilly.org/dataset/311-service-and-information-requests

Complaints: I figured we could select a subset of the 2014-2020 data (maybe some of the complaint fields?) to use, though it might be tricky if we don't have data before 2014. Let's discuss!
```{r}
service<-st_read("https://phl.carto.com/api/v2/sql?q=SELECT+*+FROM+public_cases_fc+WHERE+service_name+=+'Dangerous+Building+Complaint'&filename=service&format=geojson&skipfields=cartodb_id")
```

Sanitation Data
```{r}
sanitation<-
  st_read("https://phl.carto.com/api/v2/sql?q=SELECT+*+FROM+public_cases_fc+WHERE+service_name+=+'Sanitation+/+Dumpster+Violation'OR+service_name+=+'Illegal+Dumping'&filename=sanitation&format=geojson&skipfields=cartodb_id") %>%
    st_transform(st_crs(fishnet))

sanitation2 <-
    sanitation %>%
    mutate(year = substr(requested_datetime,1,4)) %>% 
    filter(year %in% c("2020")) %>%
    dplyr::select(Y = lat, X = lon) %>%
    na.omit() %>%
    st_as_sf(coords = c("X", "Y"), crs = 4326, agr = "constant") %>%
    st_transform(st_crs(fishnet)) %>%
    mutate(Legend = "Sanitation")

ggplot() +
  geom_sf(data = sanitation2)

```

## Aggregating features to our fishnet

```{r Putting variables into fishnet, message=FALSE, warning=FALSE, include=TRUE}

#put sanitation into fishnet. 

vars_net <- 
  rbind(sanitation2)  %>%
  st_join(., fishnet, join=st_within) %>% #if point is within this polygon, assign the polygon id to this point. then get it into the unit of grid polygons
  st_drop_geometry() %>%
  group_by(uniqueID, Legend) %>% #group by unique id and the type of variable, in this case just one cars
  summarize(count = n()) %>% #counting each point per grid cell
  full_join(fishnet, by = "uniqueID") %>%
  spread(Legend, count, fill=0) %>%
  st_sf() %>%
  dplyr::select(-`<NA>`) %>%
  na.omit() %>%
  ungroup()

```

## Nearest Neighbor Prediction Factors by Fishnet

```{r Creating iterative list, message=FALSE, warning=FALSE, include=TRUE}

vars_net.long <- 
  gather(vars_net, Variable, value, -geometry, -uniqueID)

vars <- unique(vars_net.long$Variable)
mapList <- list()

for(i in vars){
  mapList[[i]] <- 
    ggplot() +
      geom_sf(data = filter(vars_net.long, Variable == i), aes(fill=value), colour=NA) +
      scale_fill_viridis(name="") +
      labs(title=i) +
      mapTheme()}

do.call(grid.arrange,c(mapList, ncol =3, top = "Prediction Factors by Fishnet"))

nn_function <- function(measureFrom,measureTo,k) {
  measureFrom_Matrix <-
    as.matrix(measureFrom)
  measureTo_Matrix <-
    as.matrix(measureTo)
  nn <-   
    get.knnx(measureTo, measureFrom, k)$nn.dist
    output <-
      as.data.frame(nn) %>%
      rownames_to_column(var = "thisPoint") %>%
      gather(points, point_distance, V1:ncol(.)) %>%
      arrange(as.numeric(thisPoint)) %>%
      group_by(thisPoint) %>%
      summarize(pointDistance = mean(point_distance)) %>%
      arrange(as.numeric(thisPoint)) %>% 
      dplyr::select(-thisPoint) %>%
      pull()
  
  return(output)  
}


```


```{r NN function for predictors, message=FALSE, warning=FALSE, include=TRUE}
st_c <- st_coordinates
st_coid <- st_centroid

vars_net <-
  vars_net %>%
    mutate(
      Sanitation.nn =
        nn_function(st_c(st_coid(vars_net)), st_c(sanitation2),3))

      # Playground.nn =
      #   nn_function(st_c(st_coid(vars_net)), st_c(playgrounds),3),
      # Grocery_Stores.nn =
      #   nn_function(st_c(st_coid(vars_net)), st_c(groceryStores),3))
```

```{r vars net for nn features, message=FALSE, warning=FALSE, include=TRUE}
## Visualize the NN feature
vars_net.long.nn <- 
  dplyr::select(vars_net, ends_with(".nn")) %>%
    gather(Variable, value, -geometry)

vars <- unique(vars_net.long.nn$Variable)
mapList <- list()

for(i in vars){
  mapList[[i]] <- 
    ggplot() +
      geom_sf(data = filter(vars_net.long.nn, Variable == i), aes(fill=value), colour=NA) +
      scale_fill_viridis(name="") +
      labs(title=i) +
      mapTheme()}

do.call(grid.arrange,c(mapList, ncol = 3, top = "Nearest Neighbor Prediction Factors by Fishnet"))
```
## Create final net

```{r doing spatial join, message=FALSE, warning=FALSE, include=TRUE}
## important to drop the geometry from joining features
final_net <-
  left_join(permit_net, st_drop_geometry(vars_net), by="uniqueID") 

```


```{r creating final fish net, message=FALSE, warning=FALSE, include=TRUE}
#polygon to polygon joins are hard. 

final_net <-
  st_centroid(final_net) %>% #take the centroid of the fishnet
    st_join(dplyr::select(nhood, name), by = "uniqueID") %>% #spatially join those withinthe nhood polygons nd polict districs. ie assign the neighborhood to the fishnet id for whichever nhood the fishnet centroid falls into
    #st_join(dplyr::select(policeDistricts, District), by = "uniqueID") %>%
      st_drop_geometry() %>%
      left_join(dplyr::select(final_net, geometry, uniqueID)) %>%  #get the fishnet back in to get the polygons. drop the geom to do the left join and then being it back in
      st_sf() %>%
  na.omit()

# for live demo
# mapview::mapview(final_net, zcol = "District")

```
## Census Data
Census data: 
  - Income
  - Race
  - Age of housing units
  - Education level - change in education level
  - Household size
  - Household type (non family increase)
```{r}
census_api_key("337be6633f769979b1dfc56e5071279d780c2090", overwrite = TRUE)
variables=c(Median_HHInc="B19013_001",
            Med_Rent="B25064_001",
            Lack_plumb="B25048_003",
            Lack_kitc="B25052_003",
            Med_month_housecost="B25105_001",
            Month_housecost="B25104_001",
            population_own="B25026_002",
            population_rent="B25026_009",
            units_own="B25013_002",
            units_rent="B25013_007",
            total_pop="B01003_001",
            total_white="B02001_002",
            total_black="B02001_003",
            total_latino="B03002_012",
            MeanHouseSize="B25010_001",
            MedAge="B01002_001",
            MedAge_Male="B01002_002",
            MedAge_Female="B01002_003",
            Total_household="B11001_001",
            Family_household="B11001_002",
            Married_household="B11001_003",
            Otherfam_household="B11001_004",
            Non_fam_household="B11001_007",
            Household_under18="B11005_002",
            Household_over65="B11007_002",
            tot_occ_units="B25002_002",
            total_strt_2005later="B25034_002",
            total_poverty="B06012_002E",
            female_bach="B15001_050E",
            male_bach="B15001_009E")

#Need to decide what years and call the census data

Phila_18 <- get_acs(geography = "tract",
                          state = 42,
                          county= 101,
                          variables = variables,
                          year = 2018,
                          survey = "acs5",
                          geometry=T)
```